<!DOCTYPE html>
<meta charset="UTF-8">
<html>
  <head>
    <title>Compute Pressure Demo</title>
    <!-- Chrome origin trial token -->
    <meta http-equiv="origin-trial" content="AkQevalWmBczMoMwX9h5kb7teecrlJpkjDvGRQTgVVSmmHdTTHVcwYT42CUi6Z31ejoxx30kaRxVE0vzhcMURQ0AAABZeyJvcmlnaW4iOiJodHRwczovL3czYy5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IkNvbXB1dGVQcmVzc3VyZV92MiIsImV4cGlyeSI6MTcwNDQxMjc5OX0=">
  </head>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 3em 3em;
    }

    #status {
      margin-bottom: 1em;
    }

    .disabled {
      color: red;
    }

    .hidden {
      display: none;
    }

    #wrapper {
      width: 600px;
      height: 400px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #wrapper > div {
      position: absolute;
      color: white;
      font-size: 8em;
    }
  </style>
  <script src="pressure-emoji.js" type="module">
  </script>
  <body>
    <h1>Compute Pressure demo</h1>
    <div id="status-text" class="disabled">This browser doesn't support the Compute Pressure API</div>
    <div id="content" class="hidden">
      <input type=button id="calibrate" value="Broadcast"></input> <input id="skip-calibration" type="checkbox">Skip calibration</input>
      <br><br>
      <pressure-emoji></pressure-emoji>
      <br><br>
      <h1>Artificial pressure</h1>
      <div>Add pressure in parallel, by adding workers.</div>
      <br>
      <div id="wrapper" width="600" height="400">
        <canvas id="mandel" width="600" height="400"></canvas>
        <div id="counter">0</div>
      </div>
      <br>
      <button id="start">Start simulation</button>
      <button id="stop">Stop simulation</button>
      <button id="ww_add">Add worker</button>
      <button id="ww_sub">Remove worker</button>
      <br>
      <input id="scale" type="range" min="0.1" max="1" value="1" step="0.1">
      <br>
      <span id="what">Unknown</span>
      <br>
      <input id="sent" type="text"><input id="received" type="text">
      <br>
      <input id="message" type="text">
    </div>
  </body>
  <script type="module">
    import { Mandelbrot, Animator } from "./mandelbrot.js";
    import { BitDataView, MessageEncoder, MessageDecoder, toBinaryString, reverseByte } from "./binutils.js";
    import { PressureCalibrator } from "./pressure-calibrator.js";
    import { BitChannelObserver } from "./bit-channel-observer.js";
    import { BitChannelBroadcaster } from "./bit-channel-broadcaster.js";

    const mandel = new Mandelbrot(document.getElementById("mandel"));
    const animator = new Animator(mandel);

    const setWorkerCount = count => {
      animator.setWorkerCount(count);
      animateCounter();
    }
    const workerCount = () => animator.workerCount();
    const currentScale = () => animator.currentScale();

    document.getElementById("start").onclick = () => setWorkerCount(1);
    document.getElementById("stop").onclick = () => setWorkerCount(0);
    document.getElementById("ww_add").onclick = () => setWorkerCount(workerCount() + 1);
    document.getElementById("ww_sub").onclick = () => setWorkerCount(workerCount() - 1);
    document.getElementById("scale").onchange = e => animator.setScale(event.target.value);

    const delay = 4_000;

    const broadcaster = new BitChannelBroadcaster(setWorkerCount);
    broadcaster.addEventListener("bitsent", ev => {
      const bit = ev.detail.value;
      document.getElementById("sent").value += `${bit}`;
    });
    broadcaster.addEventListener("datachange", ev => {
      const type = ev.detail.type;
      const value = ev.detail.value;
      const data = ev.detail.data;

      if (type === "position") {
        document.getElementById("what").innerText = `position: ${value} (${toBinaryString(data[0])}) + checksum (${toBinaryString(data[1])})`;
      } else if (type === "character") {
        document.getElementById("what").innerText = `character: '${value}' (${toBinaryString(data[0])}) + checksum (${toBinaryString(data[1])})`;
      }
    });

    const receiver = new BitChannelObserver;
    receiver.addEventListener("bitreceived", ev => {
      const bit = ev.detail.value;
      console.log("Received", bit);
      document.getElementById("received").value += `${bit}`;
    });
    receiver.addEventListener("messagechange", ev => {
      const msg = ev.detail.value;
      document.getElementById("received").value = "";
      document.getElementById("message").value = msg;
    });

    const canvas = document.getElementById("mandel");
    const counter = document.getElementById("counter");

    const animateCounter = () => {
      const el = document.createElement("div");
      counter.innerText = workerCount();
      el.innerText = workerCount();
      canvas.insertAdjacentElement("afterend", el);

      const animation = [
        { opacity: 1, transform: 'translateY(0px) translateX(0px) scale(1)' },
        { opacity: 0, transform: `translateY(-200px) translateX(${Math.random() * 300 -150}px) scale(0.4)` }
      ];

      const timing = {
        duration: 600,
        iterations: 1,
      }
      el.animate(animation, timing).finished.then(() => el.remove());
    }

    const run = () => {
      const skipCalibrationBtn = document.getElementById("skip-calibration");
      skipCalibrationBtn.checked = sessionStorage.getItem("skip-calibration") ?? false;
      skipCalibrationBtn.onclick = ev => {
        sessionStorage.setItem("skip-calibration", ev.target.checked);
      }

      const calibrateBtn = document.getElementById("calibrate");
      calibrateBtn.onclick = async ev => {
        calibrateBtn.disabled = true;
        document.getElementById("wrapper").style = "display: none";
        const wakeLock = await navigator.wakeLock.request("screen");

        const calibrator = new PressureCalibrator(setWorkerCount);

        let calibration = { zero: 0, reset: 5, one: 8, delay: delay};
        if (!skipCalibrationBtn.checked) {
          calibration = await calibrator.calibrate()
        }
        console.log(JSON.stringify(calibration));

        const runTest = new URLSearchParams(document.location.search).has("test");
        if (!runTest) {
          broadcaster.sendMessage("hello world", calibration);
        }
        receiver.observe(runTest);
      }
    }

    if ("PressureObserver" in window) {
      document.querySelector("#status-text").classList.add("hidden");
      document.querySelector("#content").classList.remove("hidden");
      run();
    }
  </script>
</html>